{
  "hash": "e00d0e5f3dc31e71706e5a333bf468f1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Single-Sample cfDNA WGBS Analysis Report\"\nsubtitle: \"cfDNA WGBS Analysis and Prediction\"\nauthor: \"Qi Yan\"\ndate: today\ndate-format: \"MMMM D, YYYY\"\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    number-sections: true\n    code-fold: true\n    code-tools: true\n    code-summary: \"Show code\"\n    theme: cosmo\n    fig-width: 10\n    fig-height: 7\n    fig-dpi: 300\n    embed-resources: true\nparams:\n  bam_file: \"path/to/sample.bam\"\n  bismark_cov_file: \"path/to/sample.bismark.cov.gz\"\n  sample_id: \"Sample_001\"\n  output_dir: \"results\"\n  project_dir: \"..\"\nexecute:\n  echo: true\n  warning: false\n  message: false\n  cache: true\n---\n\n\n\n# Introduction\n\nThis report presents an representative analysis of a single cell-free DNA (cfDNA) sample from whole-genome bisulfite sequencing (WGBS) data. The analysis follows the same algorithms and methods used in the ALS vs Control study to ensure reproducibility and comparability.\n\n## Analysis Overview\n\nThe pipeline generates the following outputs:\n\n1. **Quality Control Metrics**: Mapping statistics, bisulfite conversion efficiency, and coverage metrics\n2. **Fragment Size Analysis**: Insert size distributions showing the characteristic cfDNA nucleosome pattern\n3. **Fragmentation Ratio Track**: Genome-wide short/long fragment ratio visualization\n4. **Genomic Distribution**: Distribution of fragment 5' start sites across genomic features\n5. **TSS Enrichment**: Nucleosome positioning signal around transcription start sites\n6. **End Motif Analysis**: 5' end 4-mer motif frequencies reflecting nuclease preferences\n7. **Classification Prediction**: Predicted group (ALS vs Ctrl) using pre-trained Random Forest model\n\n## Input Files\n\nThis notebook requires two input files:\n\n- **Bismark-aligned BAM file**: Deduplicated BAM with XM methylation tags\n- **Bismark coverage file**: Output from `bismark_methylation_extractor` (`.bismark.cov.gz`)\n\n::: {.callout-note collapse=\"true\"}\n## How to Generate Bismark Coverage File\n\nIf you only have a Bismark-aligned BAM file, run the following command to extract methylation calls:\n```bash\nbismark_methylation_extractor --gzip --bedGraph \\\n  --cytosine_report --genome_folder /path/to/genome \\\n  your_sample.bam\n```\n\nFor detailed documentation, see: [Bismark Methylation Extraction](https://felixkrueger.github.io/Bismark/bismark/methylation_extraction/)\n:::\n\n# Dependencies {#sec-dependencies}\n\nThis section lists all software dependencies required to run this analysis.\n\n## R Packages\n\n### CRAN Packages\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Required CRAN packages</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Version </th>\n   <th style=\"text-align:left;\"> Purpose </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> ggplot2 </td>\n   <td style=\"text-align:left;\"> &gt;=3.4.0 </td>\n   <td style=\"text-align:left;\"> Data visualization </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dplyr </td>\n   <td style=\"text-align:left;\"> &gt;=1.1.0 </td>\n   <td style=\"text-align:left;\"> Data manipulation </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> tidyr </td>\n   <td style=\"text-align:left;\"> &gt;=1.3.0 </td>\n   <td style=\"text-align:left;\"> Data tidying </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> readr </td>\n   <td style=\"text-align:left;\"> &gt;=2.1.0 </td>\n   <td style=\"text-align:left;\"> File I/O </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> purrr </td>\n   <td style=\"text-align:left;\"> &gt;=1.0.0 </td>\n   <td style=\"text-align:left;\"> Functional programming </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stringr </td>\n   <td style=\"text-align:left;\"> &gt;=1.5.0 </td>\n   <td style=\"text-align:left;\"> String manipulation </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> tibble </td>\n   <td style=\"text-align:left;\"> &gt;=3.2.0 </td>\n   <td style=\"text-align:left;\"> Modern data frames </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> patchwork </td>\n   <td style=\"text-align:left;\"> &gt;=1.1.0 </td>\n   <td style=\"text-align:left;\"> Plot composition </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> here </td>\n   <td style=\"text-align:left;\"> &gt;=1.0.0 </td>\n   <td style=\"text-align:left;\"> Project-relative paths </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scales </td>\n   <td style=\"text-align:left;\"> &gt;=1.2.0 </td>\n   <td style=\"text-align:left;\"> Axis formatting </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> randomForest </td>\n   <td style=\"text-align:left;\"> &gt;=4.7 </td>\n   <td style=\"text-align:left;\"> Classification model </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> knitr </td>\n   <td style=\"text-align:left;\"> &gt;=1.40 </td>\n   <td style=\"text-align:left;\"> Report generation </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kableExtra </td>\n   <td style=\"text-align:left;\"> &gt;=1.3.0 </td>\n   <td style=\"text-align:left;\"> Table formatting </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Bioconductor Packages\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Required Bioconductor packages</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Version </th>\n   <th style=\"text-align:left;\"> Purpose </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Rsamtools </td>\n   <td style=\"text-align:left;\"> &gt;=2.14.0 </td>\n   <td style=\"text-align:left;\"> BAM file handling </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> cigarillo </td>\n   <td style=\"text-align:left;\"> &gt;=1.0.0 </td>\n   <td style=\"text-align:left;\"> CIGAR string parsing </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> GenomicRanges </td>\n   <td style=\"text-align:left;\"> &gt;=1.50.0 </td>\n   <td style=\"text-align:left;\"> Genomic intervals </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> IRanges </td>\n   <td style=\"text-align:left;\"> &gt;=2.32.0 </td>\n   <td style=\"text-align:left;\"> Integer ranges </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> S4Vectors </td>\n   <td style=\"text-align:left;\"> &gt;=0.36.0 </td>\n   <td style=\"text-align:left;\"> S4 vector infrastructure </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Biostrings </td>\n   <td style=\"text-align:left;\"> &gt;=2.66.0 </td>\n   <td style=\"text-align:left;\"> DNA sequence handling </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BSgenome.Hsapiens.UCSC.hg38 </td>\n   <td style=\"text-align:left;\"> &gt;=1.4.0 </td>\n   <td style=\"text-align:left;\"> Human reference genome (hg38) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> GenomeInfoDb </td>\n   <td style=\"text-align:left;\"> &gt;=1.34.0 </td>\n   <td style=\"text-align:left;\"> Genome metadata </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> TxDb.Hsapiens.UCSC.hg38.knownGene </td>\n   <td style=\"text-align:left;\"> &gt;=3.16.0 </td>\n   <td style=\"text-align:left;\"> Gene annotations (hg38) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> GenomicFeatures </td>\n   <td style=\"text-align:left;\"> &gt;=1.50.0 </td>\n   <td style=\"text-align:left;\"> Genomic features </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ChIPseeker </td>\n   <td style=\"text-align:left;\"> &gt;=1.34.0 </td>\n   <td style=\"text-align:left;\"> Peak annotation </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> org.Hs.eg.db </td>\n   <td style=\"text-align:left;\"> &gt;=3.16.0 </td>\n   <td style=\"text-align:left;\"> Human gene IDs </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AnnotationDbi </td>\n   <td style=\"text-align:left;\"> &gt;=1.60.0 </td>\n   <td style=\"text-align:left;\"> Annotation infrastructure </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> bsseq </td>\n   <td style=\"text-align:left;\"> &gt;=1.34.0 </td>\n   <td style=\"text-align:left;\"> Bisulfite-seq analysis </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Gviz </td>\n   <td style=\"text-align:left;\"> &gt;=1.42.0 </td>\n   <td style=\"text-align:left;\"> Genomic track visualization </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## External Tools\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Required external tools</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Tool </th>\n   <th style=\"text-align:left;\"> Version </th>\n   <th style=\"text-align:left;\"> Purpose </th>\n   <th style=\"text-align:left;\"> Link </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Bismark </td>\n   <td style=\"text-align:left;\"> &gt;=0.24.0 </td>\n   <td style=\"text-align:left;\"> Bisulfite read alignment &amp; methylation extraction </td>\n   <td style=\"text-align:left;\"> [GitHub](ht </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> samtools </td>\n   <td style=\"text-align:left;\"> &gt;=1.17 </td>\n   <td style=\"text-align:left;\"> BAM file manipulation (indexing) </td>\n   <td style=\"text-align:left;\"> [GitHub](ht </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Quarto </td>\n   <td style=\"text-align:left;\"> &gt;=1.3.0 </td>\n   <td style=\"text-align:left;\"> Document rendering </td>\n   <td style=\"text-align:left;\"> [quarto.org </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n## Installation Commands\n\n```r\n# CRAN packages\ninstall.packages(c(\"ggplot2\", \"dplyr\", \"tidyr\", \"readr\", \"purrr\", \n                   \"stringr\", \"tibble\", \"patchwork\", \"here\", \"scales\",\n                   \"randomForest\", \"knitr\", \"kableExtra\"))\n\n# Bioconductor packages\nif (!require(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\n\nBiocManager::install(c(\n  \"Rsamtools\", \"cigarillo\", \"GenomicRanges\", \"IRanges\", \"S4Vectors\",\n  \"Biostrings\", \"BSgenome.Hsapiens.UCSC.hg38\", \"GenomeInfoDb\",\n  \"TxDb.Hsapiens.UCSC.hg38.knownGene\", \"GenomicFeatures\",\n  \"ChIPseeker\", \"org.Hs.eg.db\", \"AnnotationDbi\",\n  \"bsseq\", \"Gviz\"\n))\n```\n:::\n\n# Setup and Input Validation {#sec-setup}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Load required packages\nsuppressPackageStartupMessages({\n  # CRAN packages\n  library(ggplot2)\n  library(dplyr)\n  library(tidyr)\n  library(readr)\n  library(purrr)\n  library(stringr)\n  library(tibble)\n  library(patchwork)\n  library(here)\n  library(knitr)\n  library(kableExtra)\n  library(scales)\n  library(randomForest)\n  \n  # Bioconductor packages\n  library(Rsamtools)\n  library(cigarillo)\n  library(GenomicRanges)\n  library(IRanges)\n  library(S4Vectors)\n  library(Biostrings)\n  library(BSgenome.Hsapiens.UCSC.hg38)\n  library(GenomeInfoDb)\n  library(TxDb.Hsapiens.UCSC.hg38.knownGene)\n  library(GenomicFeatures)\n  library(ChIPseeker)\n  library(org.Hs.eg.db)\n  library(AnnotationDbi)\n  library(bsseq)\n  library(Gviz)\n})\n\n# Load analysis functions (from same directory as this notebook)\n# The functions file should be in the same directory as this .qmd file\nsource(\"cfDNA_analysis_functions.R\")\n\n# Set seed for reproducibility\nset.seed(389)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Parameters from YAML\nBAM_FILE <- params$bam_file\nBISMARK_COV_FILE <- params$bismark_cov_file\nSAMPLE_ID <- params$sample_id\nOUTPUT_DIR <- params$output_dir\nPROJECT_DIR <- params$project_dir\n\n# Create output directory\nif (!dir.exists(OUTPUT_DIR)) {\n  dir.create(OUTPUT_DIR, recursive = TRUE, showWarnings = FALSE)\n}\n\n# Temporary directory for intermediate files\nTEMP_DIR <- file.path(OUTPUT_DIR, \"temp\")\nif (!dir.exists(TEMP_DIR)) {\n  dir.create(TEMP_DIR, recursive = TRUE, showWarnings = FALSE)\n}\n\n# Load reference data\ngenome <- BSgenome.Hsapiens.UCSC.hg38\ntxdb <- TxDb.Hsapiens.UCSC.hg38.knownGene\n\n# Path to pre-trained model (from cohort analysis)\nMODEL_PATH <- file.path(PROJECT_DIR, \"data\", \"processed\", \"methylation\", \"rds\", \"nested_cv_results.rds\")\nSTACKHMM_PATH <- file.path(PROJECT_DIR, \"data\", \"processed\", \"hg38_genome_100_segments.bed\")\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Validate input files\nvalidation_results <- tibble::tibble(\n  File = c(\"BAM file\", \"Bismark coverage file\", \"Pre-trained model\", \"stackHMM annotations\"),\n  Path = c(BAM_FILE, BISMARK_COV_FILE, MODEL_PATH, STACKHMM_PATH),\n  Exists = c(file.exists(BAM_FILE), file.exists(BISMARK_COV_FILE), \n             file.exists(MODEL_PATH), file.exists(STACKHMM_PATH))\n)\n\nknitr::kable(validation_results, caption = \"Input file validation\") %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  kableExtra::row_spec(which(!validation_results$Exists), bold = TRUE, color = \"white\", background = \"#E64B35\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Input file validation</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> File </th>\n   <th style=\"text-align:left;\"> Path </th>\n   <th style=\"text-align:left;\"> Exists </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> BAM file </td>\n   <td style=\"text-align:left;\"> /Users/qyan/Library/CloudStorage/GoogleDrive-qyan@altoslabs.com/My Drive/Documents/Job/PrimaMente_Bioinfo/Interview/Take_home_task/cfDNA_WGBS_ALS_GSE164600/data/raw/SRR13404367.deduplicated.sorted_ds10mill_chr21.bam </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Bismark coverage file </td>\n   <td style=\"text-align:left;\"> /Users/qyan/Library/CloudStorage/GoogleDrive-qyan@altoslabs.com/My Drive/Documents/Job/PrimaMente_Bioinfo/Interview/Take_home_task/cfDNA_WGBS_ALS_GSE164600/data/processed/methylation_extractor/SRR13404367.deduplicated.sorted_ds10mill_chr21.name_sorted/SRR13404367.deduplicated.sorted_ds10mill_chr21.name_sorted.bismark.cov.gz </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Pre-trained model </td>\n   <td style=\"text-align:left;\"> ../data/processed/methylation/rds/nested_cv_results.rds </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stackHMM annotations </td>\n   <td style=\"text-align:left;\"> ../data/processed/hg38_genome_100_segments.bed </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\n# Stop if required files are missing\nrequired_files <- c(BAM_FILE, BISMARK_COV_FILE)\nmissing_required <- required_files[!file.exists(required_files)]\nif (length(missing_required) > 0) {\n  stop(\"Missing required input files:\\n\", paste(\"  -\", missing_required, collapse = \"\\n\"))\n}\n```\n:::\n\n\n# QC Metrics {#sec-qc}\n\nThis section extracts quality control metrics from the BAM file, including mapping statistics, fragment size distribution, and methylation metrics.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extract BAM metrics (this generates the fragment BED file as well)\nmessage(\"Extracting BAM metrics...\")\nmetrics <- extract_bam_metrics(\n  bam_path = BAM_FILE,\n  sample_id = SAMPLE_ID,\n  genome = genome,\n  chunk_size = 1e6,\n  frag_dir = TEMP_DIR\n)\n\n# Calculate summary statistics\nsummary_stats <- calculate_summary_stats(metrics)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Format key metrics for display\nqc_display <- tibble::tibble(\n  Metric = c(\n    \"Total Reads\",\n    \"Mapped Reads\",\n    \"Mapping Rate\",\n    \"Properly Paired\",\n    \"Proper Pair Rate\",\n    \"Duplicates\",\n    \"Duplicate Rate\",\n    \"Filtered Reads (MAPQ≥30)\",\n    \"Filter Pass Rate\",\n    \"Mean MAPQ\",\n    \"Number of Fragments\",\n    \"Mean Fragment Length\",\n    \"Median Fragment Length\",\n    \"Mode Fragment Length\",\n    \"GC Content\",\n    \"CpG Methylation\",\n    \"Bisulfite Conversion\"\n  ),\n  Value = c(\n    format(summary_stats$total_reads, big.mark = \",\"),\n    format(summary_stats$mapped_reads, big.mark = \",\"),\n    sprintf(\"%.2f%%\", summary_stats$mapping_rate * 100),\n    format(summary_stats$properly_paired, big.mark = \",\"),\n    sprintf(\"%.2f%%\", summary_stats$proper_pair_rate * 100),\n    format(summary_stats$duplicates, big.mark = \",\"),\n    sprintf(\"%.2f%%\", summary_stats$duplicate_rate * 100),\n    format(summary_stats$filtered_reads, big.mark = \",\"),\n    sprintf(\"%.2f%%\", summary_stats$filter_pass_rate * 100),\n    sprintf(\"%.1f\", summary_stats$mean_mapq),\n    format(summary_stats$n_fragments, big.mark = \",\"),\n    sprintf(\"%.1f bp\", summary_stats$mean_frag_length),\n    sprintf(\"%.0f bp\", summary_stats$median_frag_length),\n    sprintf(\"%.0f bp\", summary_stats$frag_mode),\n    sprintf(\"%.2f%%\", summary_stats$gc_content * 100),\n    sprintf(\"%.2f%%\", summary_stats$cpg_methylation * 100),\n    sprintf(\"%.2f%%\", summary_stats$bisulfite_conversion * 100)\n  )\n)\n\nknitr::kable(qc_display, caption = paste(\"QC Summary for\", SAMPLE_ID)) %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  kableExtra::pack_rows(\"Alignment Statistics\", 1, 9) %>%\n  kableExtra::pack_rows(\"Fragment Statistics\", 10, 14) %>%\n  kableExtra::pack_rows(\"Methylation Statistics\", 15, 17)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>QC Summary for SRR13404367</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:left;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr grouplength=\"9\"><td colspan=\"2\" style=\"border-bottom: 1px solid;\"><strong>Alignment Statistics</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Total Reads </td>\n   <td style=\"text-align:left;\"> 128,966 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Mapped Reads </td>\n   <td style=\"text-align:left;\"> 128,966 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Mapping Rate </td>\n   <td style=\"text-align:left;\"> 100.00% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Properly Paired </td>\n   <td style=\"text-align:left;\"> 128,966 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Proper Pair Rate </td>\n   <td style=\"text-align:left;\"> 100.00% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Duplicates </td>\n   <td style=\"text-align:left;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Duplicate Rate </td>\n   <td style=\"text-align:left;\"> 0.00% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Filtered Reads (MAPQ≥30) </td>\n   <td style=\"text-align:left;\"> 111,610 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Filter Pass Rate </td>\n   <td style=\"text-align:left;\"> 86.54% </td>\n  </tr>\n  <tr grouplength=\"5\"><td colspan=\"2\" style=\"border-bottom: 1px solid;\"><strong>Fragment Statistics</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Mean MAPQ </td>\n   <td style=\"text-align:left;\"> 38.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Number of Fragments </td>\n   <td style=\"text-align:left;\"> 55,805 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Mean Fragment Length </td>\n   <td style=\"text-align:left;\"> 174.4 bp </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Median Fragment Length </td>\n   <td style=\"text-align:left;\"> 162 bp </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Mode Fragment Length </td>\n   <td style=\"text-align:left;\"> 160 bp </td>\n  </tr>\n  <tr grouplength=\"3\"><td colspan=\"2\" style=\"border-bottom: 1px solid;\"><strong>Methylation Statistics</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> GC Content </td>\n   <td style=\"text-align:left;\"> 38.49% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> CpG Methylation </td>\n   <td style=\"text-align:left;\"> 82.71% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Bisulfite Conversion </td>\n   <td style=\"text-align:left;\"> 99.53% </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## QC Metrics Visualization {#sec-qc-viz}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Prepare data for bar chart\nqc_plot_data <- tibble::tibble(\n  metric = c(\"Total Reads (M)\", \"Filtered Reads (M)\", \"Mean MAPQ\", \n             \"Median Fragment (bp)\", \"GC Content (%)\", \n             \"CpG Methylation (%)\", \"Bisulfite Conv. (%)\"),\n  value = c(\n    summary_stats$total_reads / 1e6,\n    summary_stats$filtered_reads / 1e6,\n    summary_stats$mean_mapq,\n    summary_stats$median_frag_length,\n    summary_stats$gc_content * 100,\n    summary_stats$cpg_methylation * 100,\n    summary_stats$bisulfite_conversion * 100\n  ),\n  category = c(\"Reads\", \"Reads\", \"Quality\", \"Fragment\", \"Fragment\", \"Methylation\", \"Methylation\")\n) %>%\n  dplyr::mutate(\n    metric = factor(metric, levels = rev(metric)),\n    label = dplyr::case_when(\n      grepl(\"Reads\", metric) ~ sprintf(\"%.1fM\", value),\n      grepl(\"MAPQ\", metric) ~ sprintf(\"%.1f\", value),\n      grepl(\"Fragment\", metric) & !grepl(\"%\", metric) ~ sprintf(\"%.0f bp\", value),\n      TRUE ~ sprintf(\"%.1f%%\", value)\n    )\n  )\n\n# Create horizontal bar chart\np_qc <- ggplot(qc_plot_data, aes(x = value, y = metric, fill = category)) +\n  geom_col(width = 0.7, alpha = 0.9) +\n  geom_text(aes(label = label), hjust = -0.1, size = 3.5, fontface = \"bold\") +\n  scale_fill_brewer(palette = \"Set2\") +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.25))) +\n  labs(\n    title = paste(\"QC Metrics:\", SAMPLE_ID),\n    subtitle = \"Key quality indicators from BAM file analysis\",\n    x = \"Value\",\n    y = NULL,\n    fill = \"Category\"\n  ) +\n  theme_pub(base_size = 12) +\n  theme(\n    legend.position = \"top\",\n    panel.grid.major.y = element_blank()\n  )\n\np_qc\n```\n\n::: {.cell-output-display}\n![Key QC metrics for the sample](figures/fig-qc-barplot-1.png){#fig-qc-barplot fig-align='center' width=100%}\n:::\n:::\n\n\n# Fragmentation Analysis {#sec-fragmentation}\n\nCell-free DNA exhibits characteristic insert size patterns reflecting nucleosome protection. This section analyzes the insert size distribution and genome-wide short/long fragment ratio.\n\n## Insert Size Distribution {#sec-insert-size}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Prepare fragment length data\nfrag_df <- tibble::tibble(\n  fragment_length = metrics$fragment_lengths\n) %>%\n  dplyr::filter(fragment_length >= 80, fragment_length <= 450)\n\n# Count fragments by length\ncounts_saw <- frag_df %>%\n  dplyr::count(fragment_length, name = \"n\")\n\n# Calculate mode for annotation\ncalc_mode <- function(x) {\n  x <- x[is.finite(x)]\n  if (length(x) == 0) return(NA_integer_)\n  x <- as.integer(x)\n  tabulate(x, nbins = max(x)) |> which.max()\n}\n\nmode_bp <- calc_mode(metrics$fragment_lengths)\nmedian_bp <- median(metrics$fragment_lengths, na.rm = TRUE)\nshort_n <- sum(metrics$fragment_lengths >= 100 & metrics$fragment_lengths <= 150)\nlong_n <- sum(metrics$fragment_lengths >= 151 & metrics$fragment_lengths <= 220)\nshort_long_ratio <- if (long_n > 0) short_n / long_n else NA\n\n# Create sawtooth plot\np_sawtooth <- ggplot(counts_saw, aes(x = fragment_length, y = n)) +\n  geom_line(linewidth = 0.5, color = \"gray20\") +\n  geom_vline(xintercept = 167, linetype = \"dashed\", color = \"#E64B35\", linewidth = 0.6) +\n  geom_vline(xintercept = 334, linetype = \"dashed\", color = \"#4DBBD5\", linewidth = 0.6) +\n  annotate(\"text\", x = 175, y = max(counts_saw$n) * 0.95, \n           label = \"Mono-nucleosome\\n(~167 bp)\", hjust = 0, size = 3, color = \"#E64B35\") +\n  annotate(\"text\", x = 342, y = max(counts_saw$n) * 0.5, \n           label = \"Di-nucleosome\\n(~334 bp)\", hjust = 0, size = 3, color = \"#4DBBD5\") +\n  annotate(\"label\", x = 380, y = max(counts_saw$n) * 0.85,\n           label = sprintf(\"Median: %d bp\\nMode: %d bp\\nS/L ratio: %.3f\", \n                          as.integer(median_bp), mode_bp, short_long_ratio),\n           hjust = 0, size = 3, fill = \"white\", label.size = 0.3) +\n  labs(\n    title = \"cfDNA Fragment Size Distribution\",\n    subtitle = paste(\"Sample:\", SAMPLE_ID),\n    x = \"Fragment Length (bp)\",\n    y = \"Count\"\n  ) +\n  theme_pub(base_size = 12)\n\np_sawtooth\n```\n\n::: {.cell-output-display}\n![Fragment size distribution showing characteristic cfDNA nucleosome pattern](figures/fig-sawtooth-1.png){#fig-sawtooth fig-align='center' width=100%}\n:::\n:::\n\n\n## Fragmentation Ratio Track {#sec-frag-ratio}\n\nThe short/long fragment ratio varies across the genome and can reveal nucleosome positioning differences.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Set up genomic bins (chr21 only for efficiency)\nbin_size <- 2e6\nchroms <- \"chr21\"\nseqlens <- GenomeInfoDb::seqlengths(genome)[chroms]\nseqlens <- seqlens[!is.na(seqlens)]\n\nbins_gr <- GenomicRanges::tileGenome(\n  seqlengths = seqlens,\n  tilewidth = bin_size,\n  cut.last.tile.in.chrom = TRUE\n)\n\nbins_df <- tibble::tibble(\n  bin_id = seq_along(bins_gr),\n  chrom = as.character(GenomeInfoDb::seqnames(bins_gr)),\n  start = start(bins_gr),\n  end = end(bins_gr),\n  mid = as.integer(floor((start + end) / 2))\n)\n\n# GC content per bin\nbin_seqs <- Biostrings::getSeq(genome, bins_gr)\nfreq <- Biostrings::letterFrequency(bin_seqs, letters = c(\"A\", \"C\", \"G\", \"T\", \"N\"), as.prob = FALSE)\nacgt <- rowSums(freq[, c(\"A\", \"C\", \"G\", \"T\"), drop = FALSE])\ngc <- (freq[, \"G\"] + freq[, \"C\"]) / pmax(acgt, 1)\nn_frac <- freq[, \"N\"] / Biostrings::width(bin_seqs)\n\nbins_df <- bins_df %>%\n  dplyr::mutate(gc = as.numeric(gc), n_frac = as.numeric(n_frac))\n\n# GC filtering thresholds\ngc_min <- 0.10\ngc_max <- 0.85\nn_frac_max <- 0.45\nbins_keep_for_gc <- is.finite(bins_df$gc) &\n  bins_df$gc >= gc_min & bins_df$gc <= gc_max &\n  is.finite(bins_df$n_frac) & bins_df$n_frac <= n_frac_max\n\n# Compute bin counts\nfragment_bed_path <- file.path(TEMP_DIR, paste0(SAMPLE_ID, \".fragments.bed.gz\"))\nbin_tracks <- bin_counts_one_sample(\n  path = fragment_bed_path,\n  bins_gr = bins_gr,\n  bins_df = bins_df,\n  bins_keep_for_gc = bins_keep_for_gc\n)\n\nbin_tracks <- bin_tracks %>%\n  dplyr::left_join(bins_df, by = \"bin_id\")\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Plot fragmentation ratio track\np_frag_track <- ggplot(bin_tracks, aes(x = mid / 1e6, y = short_long_ratio)) +\n  geom_hline(yintercept = 1, color = \"gray70\", linewidth = 0.35) +\n  geom_line(linewidth = 0.8, color = \"#2E4A62\") +\n  geom_point(size = 1.5, color = \"#2E4A62\", alpha = 0.7) +\n  scale_x_continuous(breaks = seq(0, 50, by = 10)) +\n  labs(\n    title = paste(\"Fragmentation Ratio Track:\", SAMPLE_ID),\n    subtitle = sprintf(\"GC-corrected short(90-150bp)/long(151-220bp) ratio in %d Mb bins on chr21\", \n                      bin_size / 1e6),\n    x = \"Genomic Position (Mb)\",\n    y = \"Short/Long Ratio\"\n  ) +\n  theme_pub(base_size = 12)\n\np_frag_track\n```\n\n::: {.cell-output-display}\n![Genome-wide fragmentation ratio track (GC-corrected short/long ratio)](figures/fig-frag-ratio-track-1.png){#fig-frag-ratio-track fig-align='center' width=100%}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gviz visualization\nif (requireNamespace(\"Gviz\", quietly = TRUE)) {\n  genome_build <- \"hg38\"\n  chrom <- \"chr21\"\n  from_bp <- min(bins_df$start, na.rm = TRUE)\n  to_bp <- max(bins_df$end, na.rm = TRUE)\n  \n  gr_bins <- GenomicRanges::GRanges(\n    seqnames = bins_df$chrom,\n    ranges = IRanges::IRanges(start = bins_df$start, end = bins_df$end)\n  )\n  \n  y <- bin_tracks$short_long_ratio\n  y_lim <- range(y[is.finite(y)], na.rm = TRUE)\n  y_pad <- 0.15 * diff(y_lim)\n  y_lim <- c(y_lim[1] - y_pad, y_lim[2] + y_pad)\n  \n  axis_track <- Gviz::GenomeAxisTrack(genome = genome_build, chromosome = chrom, name = \"\")\n  \n  ratio_track <- Gviz::DataTrack(\n    range = gr_bins,\n    data = y,\n    genome = genome_build,\n    chromosome = chrom,\n    name = \"S/L ratio\",\n    type = \"l\",\n    col = \"#2E4A62\",\n    lwd = 2,\n    ylim = y_lim,\n    baseline = 1,\n    col.baseline = \"gray45\",\n    lty.baseline = 2,\n    lwd.baseline = 1,\n    cex.axis = 0.9,\n    cex.title = 0.9\n  )\n  \n  ideo_track <- tryCatch(\n    Gviz::IdeogramTrack(genome = genome_build, chromosome = chrom),\n    error = function(e) NULL\n  )\n  \n  tracks <- list(axis_track, ratio_track)\n  if (!is.null(ideo_track)) tracks <- c(list(ideo_track), tracks)\n  \n  Gviz::plotTracks(\n    tracks,\n    from = from_bp,\n    to = to_bp,\n    background.title = \"white\",\n    col.title = \"black\",\n    cex.title = 0.95,\n    background.panel = \"white\",\n    col.axis = \"black\",\n    col.frame = \"gray85\"\n  )\n}\n```\n\n::: {.cell-output-display}\n![Chromosome-style fragmentation ratio visualization](figures/fig-frag-ratio-gviz-1.png){#fig-frag-ratio-gviz fig-align='center' width=100%}\n:::\n:::\n\n\n# Fragment Start Site Analysis {#sec-fragment-starts}\n\nThis section analyzes the genomic distribution of fragment 5' start sites and their enrichment around transcription start sites.\n\n## Genomic Distribution {#sec-genomic-dist}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Annotate fragment 5' starts\nstart_annot <- annotate_fragment_starts_one_sample(\n  fragment_bed_gz = fragment_bed_path,\n  sample_id = SAMPLE_ID,\n  txdb = txdb\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n>> preparing features information...\t\t 2026-01-30 15:39:18 \n>> Using Genome: hg38 ...\n>> identifying nearest features...\t\t 2026-01-30 15:39:20 \n>> calculating distance from peak to TSS...\t 2026-01-30 15:39:21 \n>> assigning genomic annotation...\t\t 2026-01-30 15:39:21 \n>> Using Genome: hg38 ...\n>> Using Genome: hg38 ...\n>> adding flank feature information from peaks...\t 2026-01-30 15:40:02 \n>> assigning chromosome lengths\t\t\t 2026-01-30 15:40:07 \n>> done...\t\t\t\t\t 2026-01-30 15:40:07 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Prepare data for donut chart\nannot_data <- start_annot %>%\n  tidyr::pivot_longer(\n    cols = c(Promoter, Exon, Intron, Three_UTR, Five_UTR, Distal_Intergenic, Downstream),\n    names_to = \"annotation\",\n    values_to = \"n\"\n  ) %>%\n  dplyr::mutate(\n    pct = 100 * n / sum(n),\n    annotation = dplyr::case_when(\n      annotation == \"Three_UTR\" ~ \"3' UTR\",\n      annotation == \"Five_UTR\" ~ \"5' UTR\",\n      annotation == \"Distal_Intergenic\" ~ \"Distal Intergenic\",\n      TRUE ~ annotation\n    ),\n    annotation = factor(annotation, levels = c(\"Promoter\", \"5' UTR\", \"Exon\", \"Intron\", \n                                               \"3' UTR\", \"Downstream\", \"Distal Intergenic\"))\n  ) %>%\n  dplyr::arrange(annotation) %>%\n  dplyr::mutate(\n    ymax = cumsum(pct),\n    ymin = dplyr::lag(ymax, default = 0),\n    label_pos = (ymin + ymax) / 2,\n    label = sprintf(\"%s\\n%.1f%%\", annotation, pct)\n  )\n\n# Create donut chart\np_donut <- ggplot(annot_data, aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 2.5, fill = annotation)) +\n  geom_rect(color = \"white\", linewidth = 0.5) +\n  geom_text(aes(x = 3.25, y = label_pos, label = sprintf(\"%.1f%%\", pct)), \n            size = 3, color = \"white\", fontface = \"bold\") +\n  coord_polar(theta = \"y\") +\n  xlim(c(1, 4)) +\n  scale_fill_brewer(palette = \"Set2\") +\n  annotate(\"text\", x = 1, y = 0, label = paste(\"Total\\n\", format(start_annot$total_starts, big.mark = \",\")),\n           size = 4, fontface = \"bold\") +\n  labs(\n    title = \"Genomic Distribution of Fragment 5' Starts\",\n    subtitle = paste(\"Sample:\", SAMPLE_ID),\n    fill = \"Annotation\"\n  ) +\n  theme_void(base_size = 12) +\n  theme(\n    plot.title = element_text(face = \"bold\", hjust = 0.5, size = 14),\n    plot.subtitle = element_text(hjust = 0.5),\n    legend.position = \"right\"\n  )\n\np_donut\n```\n\n::: {.cell-output-display}\n![Genomic distribution of fragment 5' start sites](figures/fig-genomic-distribution-1.png){#fig-genomic-distribution fig-align='center' width=100%}\n:::\n:::\n\n\n## TSS Enrichment {#sec-tss-enrichment}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Get muscle-related genes on chr21\nmuscle_symbols <- c(\"COL6A1\", \"COL6A2\")\nmuscle_map <- AnnotationDbi::select(\n  org.Hs.eg.db::org.Hs.eg.db,\n  keys = muscle_symbols,\n  keytype = \"SYMBOL\",\n  columns = c(\"SYMBOL\", \"ENTREZID\")\n) %>%\n  dplyr::filter(!is.na(.data$ENTREZID)) %>%\n  dplyr::mutate(ENTREZID = as.character(.data$ENTREZID))\n\ngenes_chr21 <- suppressMessages(GenomicFeatures::genes(txdb))\ngenes_chr21 <- genes_chr21[as.character(GenomeInfoDb::seqnames(genes_chr21)) == \"chr21\"]\ngenes_muscle <- genes_chr21[as.character(genes_chr21$gene_id) %in% unique(muscle_map$ENTREZID)]\n\n# TSS windows for muscle genes\ntss_points_m <- unique(GenomicRanges::promoters(genes_muscle, upstream = 0L, downstream = 1L))\ntss_windows_m <- unique(GenomicRanges::promoters(genes_muscle, upstream = 2000L, downstream = 2000L))\ntss_site_m <- start(tss_points_m)\ntss_strand_m <- as.character(strand(tss_points_m))\n\n# Compute TSS enrichment profile\ntss_profile <- profile_tss_enrichment_starts(\n  fragment_bed_gz = fragment_bed_path,\n  tss_windows = tss_windows_m,\n  tss_site = tss_site_m,\n  tss_strand = tss_strand_m,\n  flank = 2000L\n)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Smooth the profile\ntss_profile_smooth <- tss_profile %>%\n  dplyr::mutate(\n    enrichment_smooth = moving_average(enrichment, k = 21),\n    enrichment_smooth = dplyr::if_else(is.na(enrichment_smooth), enrichment, enrichment_smooth)\n  )\n\np_tss <- ggplot(tss_profile_smooth, aes(x = rel_bp, y = enrichment_smooth)) +\n  geom_hline(yintercept = 1, color = \"gray60\", linewidth = 0.35) +\n  geom_vline(xintercept = 0, color = \"gray30\", linewidth = 0.5) +\n  geom_line(linewidth = 0.9, color = \"#2E4A62\") +\n  annotate(\"text\", x = 50, y = max(tss_profile_smooth$enrichment_smooth, na.rm = TRUE) * 0.95,\n           label = \"TSS\", hjust = 0, size = 4, fontface = \"bold\") +\n  labs(\n    title = \"TSS Enrichment of Fragment 5' Start Sites\",\n    subtitle = paste(\"Muscle genes (COL6A1, COL6A2) on chr21 | Sample:\", SAMPLE_ID),\n    x = \"Distance to TSS (bp)\",\n    y = \"Normalized Fragment Density\"\n  ) +\n  theme_pub(base_size = 12)\n\np_tss\n```\n\n::: {.cell-output-display}\n![TSS enrichment of fragment 5' start sites around muscle genes on chr21](figures/fig-tss-enrichment-1.png){#fig-tss-enrichment fig-align='center' width=100%}\n:::\n:::\n\n\n# End Motif Analysis {#sec-end-motifs}\n\nCell-free DNA fragments exhibit characteristic 5' end motif patterns reflecting the sequence preferences of nucleases involved in cfDNA generation.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extract 4-mer end motifs\nmotifs_all <- all_4mers()\nvalid_seqnames <- seqnames(genome)\n\nmotif_counts <- extract_4mer_counts_from_frag_bed(\n  frag_bed_gz = fragment_bed_path,\n  sample_id = SAMPLE_ID,\n  genome = genome,\n  valid_seqnames = valid_seqnames,\n  motifs_all = motifs_all\n)\n\n# Calculate frequencies\nmotif_freq <- motif_counts %>%\n  dplyr::mutate(\n    total = sum(count),\n    frequency = count / total\n  )\n```\n:::\n\n\n## Top 20 End Motifs {#sec-top-motifs}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Get top 20 motifs\ntop20_motifs <- motif_freq %>%\n  dplyr::arrange(desc(frequency)) %>%\n  dplyr::slice_head(n = 20) %>%\n  dplyr::mutate(motif = factor(motif, levels = rev(motif)))\n\np_top20 <- ggplot(top20_motifs, aes(x = frequency, y = motif)) +\n  geom_col(fill = \"#3C5488\", alpha = 0.9, width = 0.7) +\n  geom_text(aes(label = sprintf(\"%.4f\", frequency)), hjust = -0.1, size = 3) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.15))) +\n  labs(\n    title = \"Top 20 cfDNA 5' End Motifs (4-mer)\",\n    subtitle = paste(\"Sample:\", SAMPLE_ID),\n    x = \"Frequency\",\n    y = \"Motif\"\n  ) +\n  theme_pub(base_size = 12) +\n  theme(panel.grid.major.y = element_blank())\n\np_top20\n```\n\n::: {.cell-output-display}\n![Top 20 cfDNA 5' end motifs (4-mer)](figures/fig-top20-motifs-1.png){#fig-top20-motifs fig-align='center' width=100%}\n:::\n:::\n\n## Motif Diversity Score {#sec-mds}\n\nThe Motif Diversity Score (MDS) is calculated as the normalized Shannon entropy of the 256 4-mer frequencies.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Calculate MDS\nfreq_vec <- motif_freq$frequency\nentropy_bits <- shannon_entropy_bits(freq_vec)\nmax_entropy <- log2(256)  # Maximum possible entropy for 256 motifs\nmds <- entropy_bits / max_entropy\n\nmds_display <- tibble::tibble(\n  Metric = c(\"Shannon Entropy (bits)\", \"Maximum Entropy (bits)\", \"Motif Diversity Score (MDS)\"),\n  Value = c(sprintf(\"%.4f\", entropy_bits), sprintf(\"%.4f\", max_entropy), sprintf(\"%.4f\", mds))\n)\n\nknitr::kable(mds_display, caption = \"End Motif Diversity Metrics\") %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>End Motif Diversity Metrics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:left;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Shannon Entropy (bits) </td>\n   <td style=\"text-align:left;\"> 7.6745 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Maximum Entropy (bits) </td>\n   <td style=\"text-align:left;\"> 8.0000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Motif Diversity Score (MDS) </td>\n   <td style=\"text-align:left;\"> 0.9593 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Create a simple gauge-like visualization for MDS\np_mds <- ggplot() +\n  geom_rect(aes(xmin = 0, xmax = 1, ymin = 0, ymax = 1), fill = \"gray90\") +\n  geom_rect(aes(xmin = 0, xmax = mds, ymin = 0, ymax = 1), fill = \"#3C5488\", alpha = 0.8) +\n  geom_text(aes(x = 0.5, y = 0.5, label = sprintf(\"MDS = %.4f\", mds)), \n            size = 8, fontface = \"bold\", color = \"white\") +\n  geom_text(aes(x = 0.5, y = -0.3, label = \"Shannon entropy of 256 4-mer frequencies (normalized)\"),\n            size = 3.5, color = \"gray40\") +\n  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +\n  scale_y_continuous(limits = c(-0.5, 1.2)) +\n  labs(title = paste(\"Motif Diversity Score:\", SAMPLE_ID)) +\n  theme_void(base_size = 12) +\n  theme(\n    plot.title = element_text(face = \"bold\", hjust = 0.5, size = 14, margin = ggplot2::margin(b = 10)),\n    axis.text.x = element_text(color = \"gray30\"),\n    axis.ticks.x = element_line(color = \"gray30\")\n  )\n\np_mds\n```\n\n::: {.cell-output-display}\n![Motif Diversity Score (MDS) - Normalized Shannon entropy of 256 4-mer frequencies](figures/fig-mds-gauge-1.png){#fig-mds-gauge fig-align='center' width=100%}\n:::\n:::\n\n\n# Classification Prediction {#sec-classification}\n\nThis section uses the pre-trained Random Forest model to predict whether the sample belongs to the ALS or Control group based on methylation features.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Check if model exists\nmodel_available <- file.exists(MODEL_PATH) && file.exists(STACKHMM_PATH)\n\nif (model_available) {\n  # Load pre-trained model\n  all_results <- readRDS(MODEL_PATH)\n  \n  # Load stackHMM annotations\n  stackhmm_df <- readr::read_tsv(\n    STACKHMM_PATH,\n    col_names = c(\"chr\", \"start\", \"end\", \"state\"),\n    col_types = \"ciic\",\n    progress = FALSE\n  ) %>%\n    dplyr::filter(chr == \"chr21\")\n  \n  stackhmm_gr <- GenomicRanges::GRanges(\n    seqnames = stackhmm_df$chr,\n    ranges = IRanges::IRanges(start = stackhmm_df$start + 1L, end = stackhmm_df$end),\n    state = stackhmm_df$state\n  )\n  states <- unique(stackhmm_df$state)\n  \n  # Load methylation data from bismark coverage file\n  bs <- bsseq::read.bismark(\n    files = BISMARK_COV_FILE,\n    rmZeroCov = TRUE,\n    strandCollapse = TRUE,\n    verbose = FALSE\n  )\n  \n  # Extract methylation values\n  cpg_gr <- GenomicRanges::granges(bs)\n  meth_mat <- bsseq::getMeth(bs, type = \"raw\", what = \"perBase\")\n  \n  # Calculate stackHMM methylation features\n  stackhmm_meth <- numeric(length(states))\n  names(stackhmm_meth) <- states\n  \n  for (i in seq_along(states)) {\n    cpg_idx <- S4Vectors::queryHits(\n      GenomicRanges::findOverlaps(cpg_gr, stackhmm_gr[stackhmm_gr$state == states[i]])\n    )\n    if (length(cpg_idx) > 0) {\n      stackhmm_meth[states[i]] <- median(meth_mat[cpg_idx, 1], na.rm = TRUE)\n    } else {\n      stackhmm_meth[states[i]] <- NA\n    }\n  }\n  \n  # Prepare features for prediction (using stackHMM model)\n  model_result <- all_results[[\"stackHMM\"]]\n  selected_features <- model_result$selected_features\n  \n  # Create feature matrix\n  new_features <- matrix(stackhmm_meth[selected_features], nrow = 1,\n                         dimnames = list(SAMPLE_ID, selected_features))\n  \n  # Handle missing features\n  new_features[is.na(new_features)] <- 0\n  \n  # Make prediction\n  prediction <- predict_single_sample(new_features, model_result)\n  \n  prediction_available <- TRUE\n} else {\n  prediction_available <- FALSE\n  message(\"Pre-trained model not available. Skipping classification prediction.\")\n}\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (prediction_available) {\n  # Display prediction results\n  pred_class <- prediction$predicted_class\n  pred_prob <- prediction$probabilities\n  \n  pred_color <- if (pred_class == \"ALS\") \"#E64B35\" else \"#4DBBD5\"\n  \n  cat(\"\\n\")\n}\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (prediction_available) {\n  # Create prediction visualization\n  prob_data <- tibble::tibble(\n    Group = c(\"Ctrl\", \"ALS\"),\n    Probability = c(pred_prob$Ctrl, pred_prob$ALS)\n  ) %>%\n    dplyr::mutate(Group = factor(Group, levels = c(\"Ctrl\", \"ALS\")))\n  \n  # Create label for binary prediction\n  confidence <- max(pred_prob$Ctrl, pred_prob$ALS) * 100\n  prediction_label <- sprintf(\"Prediction: %s (%.1f%% confidence)\", pred_class, confidence)\n  \n  p_pred <- ggplot(prob_data, aes(x = Group, y = Probability, fill = Group)) +\n    geom_col(width = 0.6, alpha = 0.9) +\n    geom_text(aes(label = sprintf(\"%.1f%%\", Probability * 100)), \n              vjust = -0.5, size = 5, fontface = \"bold\") +\n    geom_hline(yintercept = 0.5, linetype = \"dashed\", color = \"gray50\") +\n    annotate(\"label\", x = 1.5, y = 0.95, label = prediction_label,\n             size = 5, fontface = \"bold\", fill = pred_color, color = \"white\",\n             label.padding = unit(0.5, \"lines\"), label.r = unit(0.3, \"lines\")) +\n    scale_fill_manual(values = COLORS) +\n    scale_y_continuous(limits = c(0, 1.15), labels = scales::percent) +\n    labs(\n      title = \"Classification Prediction Result\",\n      subtitle = paste(\"Sample:\", SAMPLE_ID, \"| Model: stackHMM methylation features\"),\n      x = NULL,\n      y = \"Prediction Probability\"\n    ) +\n    theme_pub(base_size = 14) +\n    theme(legend.position = \"none\")\n  \n  print(p_pred)\n}\n```\n\n::: {.cell-output-display}\n![Classification prediction result](figures/fig-prediction-1.png){#fig-prediction fig-align='center' width=100%}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (prediction_available) {\n  pred_table <- tibble::tibble(\n    Metric = c(\"Predicted Class\", \"Ctrl Probability\", \"ALS Probability\", \"Confidence\"),\n    Value = c(\n      pred_class,\n      sprintf(\"%.2f%%\", pred_prob$Ctrl * 100),\n      sprintf(\"%.2f%%\", pred_prob$ALS * 100),\n      sprintf(\"%.2f%%\", max(pred_prob$Ctrl, pred_prob$ALS) * 100)\n    )\n  )\n  \n  knitr::kable(pred_table, caption = \"Classification Prediction Results\") %>%\n    kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n    kableExtra::row_spec(1, bold = TRUE, color = \"white\", background = pred_color)\n}\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Classification Prediction Results</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:left;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;color: white !important;background-color: rgba(230, 75, 53, 255) !important;\"> Predicted Class </td>\n   <td style=\"text-align:left;font-weight: bold;color: white !important;background-color: rgba(230, 75, 53, 255) !important;\"> ALS </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Ctrl Probability </td>\n   <td style=\"text-align:left;\"> 25.80% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ALS Probability </td>\n   <td style=\"text-align:left;\"> 74.20% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Confidence </td>\n   <td style=\"text-align:left;\"> 74.20% </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Summary {#sec-summary}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Compile all key results\nsummary_results <- tibble::tibble(\n  Category = c(\n    rep(\"Quality Control\", 5),\n    rep(\"Fragment Analysis\", 4),\n    rep(\"End Motifs\", 2),\n    if (prediction_available) \"Classification\" else character(0)\n  ),\n  Metric = c(\n    \"Total Reads\", \"Mapping Rate\", \"Bisulfite Conversion\", \"CpG Methylation\", \"Mean MAPQ\",\n    \"Median Fragment Length\", \"Mode Fragment Length\", \"Short/Long Ratio\", \"TSS Enrichment Score\",\n    \"Top Motif\", \"Motif Diversity (MDS)\",\n    if (prediction_available) \"Predicted Group\" else character(0)\n  ),\n  Value = c(\n    format(summary_stats$total_reads, big.mark = \",\"),\n    sprintf(\"%.2f%%\", summary_stats$mapping_rate * 100),\n    sprintf(\"%.2f%%\", summary_stats$bisulfite_conversion * 100),\n    sprintf(\"%.2f%%\", summary_stats$cpg_methylation * 100),\n    sprintf(\"%.1f\", summary_stats$mean_mapq),\n    sprintf(\"%d bp\", as.integer(summary_stats$median_frag_length)),\n    sprintf(\"%d bp\", summary_stats$frag_mode),\n    sprintf(\"%.3f\", short_long_ratio),\n    sprintf(\"%.2f\", max(tss_profile$enrichment, na.rm = TRUE)),\n    as.character(top20_motifs$motif[1]),\n    sprintf(\"%.4f\", mds),\n    if (prediction_available) sprintf(\"%s (%.1f%%)\", pred_class, max(pred_prob) * 100) else character(0)\n  )\n)\n\nknitr::kable(summary_results, caption = paste(\"Analysis Summary for\", SAMPLE_ID)) %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  kableExtra::pack_rows(\"Quality Control\", 1, 5) %>%\n  kableExtra::pack_rows(\"Fragment Analysis\", 6, 9) %>%\n  kableExtra::pack_rows(\"End Motifs\", 10, 11) %>%\n  {if (prediction_available) kableExtra::pack_rows(., \"Classification\", 12, 12) else .}\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Analysis Summary for SRR13404367</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Category </th>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:left;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr grouplength=\"5\"><td colspan=\"3\" style=\"border-bottom: 1px solid;\"><strong>Quality Control</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Quality Control </td>\n   <td style=\"text-align:left;\"> Total Reads </td>\n   <td style=\"text-align:left;\"> 128,966 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Quality Control </td>\n   <td style=\"text-align:left;\"> Mapping Rate </td>\n   <td style=\"text-align:left;\"> 100.00% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Quality Control </td>\n   <td style=\"text-align:left;\"> Bisulfite Conversion </td>\n   <td style=\"text-align:left;\"> 99.53% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Quality Control </td>\n   <td style=\"text-align:left;\"> CpG Methylation </td>\n   <td style=\"text-align:left;\"> 82.71% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Quality Control </td>\n   <td style=\"text-align:left;\"> Mean MAPQ </td>\n   <td style=\"text-align:left;\"> 38.1 </td>\n  </tr>\n  <tr grouplength=\"4\"><td colspan=\"3\" style=\"border-bottom: 1px solid;\"><strong>Fragment Analysis</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Fragment Analysis </td>\n   <td style=\"text-align:left;\"> Median Fragment Length </td>\n   <td style=\"text-align:left;\"> 162 bp </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Fragment Analysis </td>\n   <td style=\"text-align:left;\"> Mode Fragment Length </td>\n   <td style=\"text-align:left;\"> 160 bp </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Fragment Analysis </td>\n   <td style=\"text-align:left;\"> Short/Long Ratio </td>\n   <td style=\"text-align:left;\"> 0.438 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Fragment Analysis </td>\n   <td style=\"text-align:left;\"> TSS Enrichment Score </td>\n   <td style=\"text-align:left;\"> -Inf </td>\n  </tr>\n  <tr grouplength=\"2\"><td colspan=\"3\" style=\"border-bottom: 1px solid;\"><strong>End Motifs</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> End Motifs </td>\n   <td style=\"text-align:left;\"> Top Motif </td>\n   <td style=\"text-align:left;\"> AAAA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> End Motifs </td>\n   <td style=\"text-align:left;\"> Motif Diversity (MDS) </td>\n   <td style=\"text-align:left;\"> 0.9593 </td>\n  </tr>\n  <tr grouplength=\"1\"><td colspan=\"3\" style=\"border-bottom: 1px solid;\"><strong>Classification</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> Classification </td>\n   <td style=\"text-align:left;\"> Predicted Group </td>\n   <td style=\"text-align:left;\"> ALS (74.2%) </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Methods {#sec-methods}\n\n## Data Processing\n\nThe BAM file was processed using custom R functions that implement the following pipeline:\n\n1. **Read Filtering**: Reads were filtered to retain properly paired, non-duplicate alignments with MAPQ ≥ 30.\n2. **Fragment Extraction**: Fragment coordinates were derived from paired-end alignments using the union span of mate alignments.\n3. **GC Content**: Fragment GC content was calculated as (G+C)/(A+C+G+T) excluding N bases.\n4. **Methylation Extraction**: CpG methylation was extracted from Bismark XM tags or coverage files.\n\n## Fragmentation Analysis\n\n- **Insert Size Distribution**: Fragment lengths were computed from paired-end alignment coordinates.\n- **Short/Long Ratio**: Ratio of fragments 90-150 bp (short) to 151-220 bp (long).\n- **GC Correction**: LOESS regression was used to correct for GC bias in fragment counts.\n\n## End Motif Analysis\n\n- **Motif Extraction**: 4-mer sequences were extracted from both 5' ends of each fragment (strand-aware).\n- **Motif Diversity Score**: Calculated as normalized Shannon entropy: MDS = H(p) / log₂(256).\n\n## Classification\n\n- **Model**: Random Forest classifier trained on ALS vs Control cohort data.\n- **Features**: stackHMM-based regional methylation levels (100 chromatin states).\n- **Validation**: Nested cross-validation (LOOCV outer, 5-fold inner) with Boruta feature selection.\n\n## Software\n\nThis analysis was performed using R version R version 4.5.1 (2025-06-13) with Bioconductor packages for genomic analysis. All core algorithms are identical to those used in the cohort analysis to ensure reproducibility.\n\n---\n\n*Report generated on 2026-01-30 16:19:22.425818*\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}